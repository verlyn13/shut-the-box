# Rye to uv Migration Research Report

**Project**: Shut the Box Simulation (`stbsim`)  
**Date**: May 24, 2025  
**Research Based On**: `/home/verlyn13/Projects/shut-the-box/shut_the_box_sim/tmp/refactor-to-uv.md`

## Executive Summary

This comprehensive research report evaluates the feasibility and requirements for migrating the `stbsim` project from Rye to uv. The migration is **feasible and recommended**, with moderate complexity due to CI integration requirements and some feature gaps that need workarounds.

**Key Recommendation**: Proceed with migration using a phased approach, starting with a spike branch to validate CI functionality.

---

## Section 1: Current State Inventory

### 1.1 Repository Structure
```
shut-the-box/
‚îú‚îÄ‚îÄ analysis/                    # Quarto analysis reports
‚îÇ   ‚îú‚îÄ‚îÄ _quarto.yml
‚îÇ   ‚îî‚îÄ‚îÄ strategy_comparison_*.qmd
‚îî‚îÄ‚îÄ shut_the_box_sim/           # Main Python project (Rye managed)
    ‚îú‚îÄ‚îÄ pyproject.toml          # Rye configuration
    ‚îú‚îÄ‚îÄ .python-version         # Python 3.12.9 pinned
    ‚îú‚îÄ‚îÄ requirements*.lock      # Rye lockfiles
    ‚îú‚îÄ‚îÄ scripts/                # Shell scripts for lint/typecheck
    ‚îú‚îÄ‚îÄ src/stbsim/            # Source code
    ‚îî‚îÄ‚îÄ tests/                 # Test suite
```

### 1.2 Rye Footprint Analysis
**High Impact Files** (45 references found):
- `.github/workflows/ci.yml`: 7 `rye` commands in CI pipeline
- `pyproject.toml`: `[tool.rye]` section with 16 scripts
- Documentation: 32 references across README, COMMANDS.md, DEVELOPMENT_GUIDE.md
- Requirements lockfiles: Generated by `rye sync`

**Current Rye Features in Use**:
- **Dependency Management**: `rye sync`, lockfiles (`requirements.lock`, `requirements-dev.lock`)
- **Script Execution**: 16 scripts defined in `[tool.rye.scripts]`
- **Development Commands**: `autofix`, `lint`, `typecheck`, `test`, `test-cov`
- **CI Integration**: `eifinger/setup-rye@v3` action
- **Python Version Pinning**: `.python-version` (3.12.9)

### 1.3 CI Pipeline Details
**Current CI Jobs**:
1. **build** job: Rye setup ‚Üí sync ‚Üí lint ‚Üí typecheck ‚Üí test-cov ‚Üí CLI smoke test
2. **docs** job: Rye setup ‚Üí sync ‚Üí Quarto render

**CI Dependencies**:
- `eifinger/setup-rye@v3`
- Python 3.12.9 (pinned, single version)
- Ubuntu latest runner
- Coverage artifact upload

### 1.4 Build and Packaging
- **Build Backend**: Hatchling (`hatchling.build`)
- **Package Name**: `stbsim`
- **Current Version**: 0.1.0
- **No Publishing**: No evidence of PyPI publishing workflow
- **Entry Points**: CLI via `python -m stbsim.cli`

---

## Section 2: Stakeholder Requirements Analysis

### 2.1 Python Version Strategy
**Current**: Single Python version (3.12.9) pinned via `.python-version`
**CI Approach**: Single-version testing only
**Recommendation**: ‚úÖ **Keep single-version approach** 
- Simplifies migration
- Maintains current reproducibility
- Can expand to matrix testing later if needed

### 2.2 Development Workflow Requirements
**Must Preserve**:
- `autofix` ‚Üí `lint` ‚Üí `test` development cycle
- All 16 existing scripts in `[tool.rye.scripts]`
- Pre-commit hooks functionality
- Coverage reporting with HTML output
- CLI smoke testing in CI

**Single-Command Onboarding Target**: 
`uv sync --dev && uv run autofix && uv run test`

### 2.3 Release and Publishing
**Current Status**: No automated publishing detected
**Requirements**: Maintain ability to build wheels with Hatchling
**Future Consideration**: uv supports `uv build` and `uv publish` when needed

---

## Section 3: External Landscape Research

### 3.1 uv Feature Mapping

| Rye Feature | uv Equivalent | Status | Notes |
|-------------|---------------|---------|-------|
| `rye sync` | `uv sync` | ‚úÖ Full | Direct replacement |
| `rye add <pkg>` | `uv add <pkg>` | ‚úÖ Full | Same syntax |
| `rye run <script>` | `uv run <script>` | ‚úÖ Full | Same syntax |
| `[tool.rye.scripts]` | `[tool.uv.scripts]` | ‚úÖ Full | Configuration change only |
| `requirements.lock` | `uv.lock` | ‚úÖ Full | Different format, same purpose |
| `.python-version` | `[tool.uv].python` | ‚ö†Ô∏è Partial | Can use either approach |
| Python installation | `uv python install` | ‚úÖ Full | Enhanced functionality |

### 3.2 CI Integration: setup-uv vs setup-rye

| Feature | setup-rye@v3 | setup-uv@v6 | Migration Impact |
|---------|--------------|-------------|------------------|
| Python Installation | Via setup-python | Built-in `uv python install` | ‚úÖ Simplification |
| Dependency Caching | Manual | Built-in with `enable-cache: true` | ‚úÖ Improvement |
| Performance | Standard | 10-100x faster resolution | ‚úÖ Speed boost |
| Lockfile Support | Rye format | uv format | ‚ö†Ô∏è Migration needed |

### 3.3 Known Migration Issues
**From Research**:
1. **Configuration**: `[tool.rye]` ‚Üí `[tool.uv]` namespace change
2. **Lockfile Format**: Different format requires regeneration
3. **Scripts**: Identical syntax, just namespace change
4. **Virtual Projects**: `virtual=true` ‚Üí `package=false` (not applicable here)

**Migration Tools Available**:
- `rye-uv` CLI tool (v0.1.3) - **Not recommended for production**
- Manual migration preferred for transparency and control

---

## Section 4: Risk Assessment & Decision Matrix

### 4.1 High Priority Decisions

| Decision | Options | Risk Level | Recommendation |
|----------|---------|------------|----------------|
| **Lockfile Migration** | Regenerate from scratch vs Convert | üü° Medium | Regenerate - ensures clean state |
| **CI Cache Strategy** | Keep existing vs Enable uv cache | üü¢ Low | Enable uv cache - performance benefit |
| **Python Version Management** | Keep `.python-version` vs Move to pyproject.toml | üü¢ Low | Keep `.python-version` - less change |
| **Script Migration Timing** | All at once vs Gradual | üü° Medium | All at once - atomic change |

### 4.2 Migration Risks

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| CI pipeline breaks | üî¥ High | üü° Medium | Spike branch testing |
| Development workflow disruption | üü° Medium | üü¢ Low | Preserve all script names |
| Dependency resolution issues | üü° Medium | üü¢ Low | Lock before migration |
| Documentation drift | üü¢ Low | üî¥ High | Update docs atomically |

---

## Section 5: Migration Plan & Recommendations

### 5.1 Recommended Migration Strategy

**Phase 1: Preparation (Day 1-2)**
1. ‚úÖ Document current working state
2. ‚úÖ Lock current dependencies (`rye lock`)
3. ‚úÖ Validate all tests pass
4. ‚úÖ Create migration branch `feature/migrate-to-uv`

**Phase 2: Core Migration (Day 3-4)**
1. Replace `[tool.rye]` with `[tool.uv]` in `pyproject.toml`
2. Remove `requirements*.lock` files
3. Run `uv sync --dev` to generate `uv.lock`
4. Update all documentation references
5. Test locally: `uv run autofix && uv run lint && uv run test`

**Phase 3: CI Migration (Day 5)**
1. Replace `eifinger/setup-rye@v3` with `astral-sh/setup-uv@v6`
2. Update CI commands from `rye` to `uv`
3. Enable uv caching
4. Test CI pipeline thoroughly

**Phase 4: Validation (Day 6-7)**
1. Run complete test suite
2. Verify CLI smoke test
3. Test Quarto integration
4. Performance comparison
5. Team validation

### 5.2 Specific Configuration Changes

**pyproject.toml Changes**:
```toml
# FROM:
[tool.rye]
managed = true
dev-dependencies = [...]

[tool.rye.scripts]
lint = "sh scripts/lint.sh"
# ... other scripts

# TO:
[tool.uv]
managed = true
dev-dependencies = [...]

[tool.uv.scripts]
lint = "sh scripts/lint.sh"
# ... other scripts (identical)
```

**CI Workflow Changes**:
```yaml
# FROM:
- name: Setup Rye
  uses: eifinger/setup-rye@v3
- name: Sync dependencies with Rye
  run: rye sync

# TO:
- name: Setup uv
  uses: astral-sh/setup-uv@v6
  with:
    python-version: "3.12.9"
    enable-cache: true
- name: Sync dependencies with uv
  run: uv sync --dev
```

### 5.3 Success Criteria

‚úÖ **Primary Success Criteria**:
- All CI jobs pass (lint, typecheck, test, CLI smoke test)
- All development scripts work identically (`uv run autofix`, etc.)
- No functionality regression
- Documentation updated completely

‚úÖ **Secondary Success Criteria**:
- CI performance improvement (faster dependency resolution)
- Simplified onboarding command
- Future-proofed for uv ecosystem evolution

---

## Section 6: Post-Migration Benefits

### 6.1 Immediate Benefits
- **Performance**: 10-100x faster dependency resolution
- **Simplification**: Single tool for all Python packaging needs
- **CI Efficiency**: Built-in caching, faster builds
- **Future-Proofing**: Aligned with Astral's roadmap

### 6.2 Long-term Strategic Benefits
- **Ecosystem Alignment**: uv is becoming the standard
- **Feature Evolution**: Active development, new features
- **Community**: Growing adoption and support
- **Toolchain Consolidation**: Reduce tool dependencies

---

## Section 7: Implementation Timeline

| Milestone | Target Date | Owner | Deliverable |
|-----------|-------------|--------|-------------|
| **Research Complete** | Day 0 ‚úÖ | Team | This report |
| **Spike Branch** | Day +2 | Dev | Working uv branch with CI |
| **Full Migration** | Day +5 | Dev | Complete migration PR |
| **Team Review** | Day +6 | Team | Approved migration |
| **Merge to Main** | Day +7 | Tech Lead | Production deployment |
| **Documentation** | Day +8 | Team | Updated guides |

---

## Section 8: Appendices

### 8.1 Complete File Inventory
**Files Requiring Updates**:
- `pyproject.toml` - Configuration changes
- `.github/workflows/ci.yml` - CI pipeline updates
- `README.md` - Command examples (32 references)
- `COMMANDS.md` - Development workflow
- `DEVELOPMENT_GUIDE.md` - Setup instructions
- `CODE_STANDARDS.md` - Tool references

**Files Requiring Deletion**:
- `requirements.lock`
- `requirements-dev.lock`

**Files Generated**:
- `uv.lock` (replaces requirements lockfiles)

### 8.2 Rollback Plan
If migration fails:
1. Revert to previous Git state
2. Restore `requirements*.lock` files
3. Re-run `rye sync` 
4. Restore CI configuration
5. Validate full test suite

**Recovery Time**: < 30 minutes

---

## Conclusion

The migration from Rye to uv is **recommended and feasible** with moderate complexity. The primary challenges are in CI integration and ensuring all development workflows continue seamlessly. The benefits of improved performance, future-proofing, and ecosystem alignment outweigh the migration effort.

**Next Steps**: 
1. ‚úÖ Approve this research report
2. Create spike branch for validation
3. Execute phased migration plan
4. Monitor performance improvements

*This report provides a complete foundation for the Rye to uv migration decision and implementation.*